---
- name: Bootstrap development environment
  hosts: localhost
  vars:
    git_dir: "{{ ansible_env.HOME }}/git"
    dotfiles_dir: "{{ git_dir }}/dotfiles"
    source_key: "{{ dotfiles_dir }}/ssh/id_ed25519"
    dest_key: "{{ ansible_env.HOME }}/.ssh/id_ed25519"
  tasks:
    - name: Install packages with apt
      become: yes
      apt:
        name:
          - git
          - tmux
          - kitty
          - unzip
          - wget
        state: latest
      when: ansible_facts['os_family'] == "Debian"
    - name: Install i3 window manager
      become: yes
      block:
        - name: Download i3 keyring
          command:
            cmd: /usr/lib/apt/apt-helper download-file https://debian.sur5r.net/i3/pool/main/s/sur5r-keyring/sur5r-keyring_2024.03.04_all.deb keyring.deb SHA256:f9bb4340b5ce0ded29b7e014ee9ce788006e9bbfe31e96c09b2118ab91fca734
          args:
            creates: keyring.deb

        - name: Install i3 keyring
          apt:
            deb: ./keyring.deb

        - name: Add i3 repository
          shell: |
            echo "deb http://debian.sur5r.net/i3/ $(grep '^DISTRIB_CODENAME=' /etc/lsb-release | cut -f2 -d=) universe" | tee /etc/apt/sources.list.d/sur5r-i3.list
          args:
            creates: /etc/apt/sources.list.d/sur5r-i3.list

        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install i3
          apt:
            name: i3
            state: present
    - name: Build and install CMake from source
      become: yes
      vars:
        cmake_version: "3.30"
        cmake_build: "5"
        cmake_dir: "/tmp/cmake-{{ cmake_version }}.{{ cmake_build }}"
      block:
        - name: Download and extract CMake source
          unarchive:
            src: "https://cmake.org/files/v{{ cmake_version }}/cmake-{{ cmake_version }}.{{ cmake_build }}.tar.gz"
            dest: /tmp
            remote_src: yes
            creates: "{{ cmake_dir }}"

        - name: Build and install CMake
          shell: |
            cd {{ cmake_dir }}
            ./bootstrap
            make -j$(nproc)
            make install
          args:
            creates: /usr/local/bin/cmake

      when: ansible_facts['os_family'] == "Debian"
    - name: Create ~/git directory
      file:
        path: "{{ git_dir }}"
        state: directory
        mode: 0755
    - name: Clone the dotfiles repository
      git:
        repo: https://github.com/g-tejas/dotfiles.git
        dest: "{{ dotfiles_dir }}"
    - name: Ensure the SSH directory exists
      become_user: root
      file:
        dest: "{{ dest_key | dirname }}"
        state: directory
        mode: 0700
    - name: Decrypt the SSH key
      command: ansible-vault decrypt "{{ source_key }}" --output="{{ dest_key }}"
      become_user: root
    - name: Copy over the public key
      copy:
        src: "{{ source_key }}.pub"
        dest: "{{ dest_key }}.pub"
        mode: 0600
    - name: Set permissions for the decrypted key
      ansible.builtin.file:
        path: "{{ dest_key }}.pub"
        mode: 0600
    - name: Set authorized key
      authorized_key:
        user: "{{ lookup('env', 'USER') }}"
        state: present
        key: "{{ lookup('file', item) }}"
      with_fileglob:
        - "{{ dotfiles_dir }}/ssh/*.pub"
